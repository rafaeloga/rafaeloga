{"version":"NotebookV1","origId":3623476344927183,"name":"8.2 Managing Records","language":"sql","commands":[{"version":"CommandV1","origId":3623476344927184,"guid":"299affa8-b668-469b-9797-879b11974c8c","subtype":"command","commandType":"auto","position":1.0,"command":"\n%md-sandbox\n\n<div style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://databricks.com/wp-content/uploads/2018/03/db-academy-rgb-1200px.png\" alt=\"Databricks Learning\" style=\"width: 600px\">\n</div>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"eb397efb-b1c7-4ab3-bee7-0671184c6eea"},{"version":"CommandV1","origId":3623476344927185,"guid":"6323e049-4896-46dd-9de3-e833a9026b84","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n# Managing Records\n\nIn the previous reading we demonstrated how to create a Delta table. We used basic data exploration strategies to identify two problems within the data. In this notebook, we will demonstrate how to correct those problems and write to a new, clean gold-level table that you can use for queries. Also, we will demonstrate how to repair and correct records\n\nIn this notebook, you will:\n* Use a window function to interpolate missing values\n* Update a Delta table\n* Check the version history in a Delta table","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6db75d48-aa99-435b-817f-1a3f7eaad5bc"},{"version":"CommandV1","origId":3623476344927186,"guid":"cce4a56f-80d7-4fac-836c-60708dfd3646","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n## Getting started\n\nRun the cell below to set up your classroom environment","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"dea6101b-8b19-4f1c-b78b-1ec756c180f5"},{"version":"CommandV1","origId":3623476344927187,"guid":"dcc7beed-bcd7-4853-b848-55c3ae861b8d","subtype":"command","commandType":"auto","position":4.0,"command":"%run ../Includes/8-2-Setup","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f1e11ed3-6438-4698-b62c-b60f7ff75796"},{"version":"CommandV1","origId":3623476344927188,"guid":"53207663-436c-4508-92d8-fe59a008e341","subtype":"command","commandType":"auto","position":5.0,"command":"%md-sandbox\n## Repairing Records\n\nIn the previous reading, we found two problems in the data: \n\n1. We were missing records on a single device for a period of three days\n1. There was at least one broken reading (heartrate less than zero) per day in our set\n\nWe will start by demonstrating how to merge a set of updates and insertions to repair these problems. \n\nFirst, we will work on the broken sensor readings. Previously, you used a window function, paired with the `AVG` function, to calculate an average value over a group of rows. Here, we will use a window function, paired with the built-in functions `LAG` and `LEAD`, to interpolate values to replace the broken readings. \n\n**`LAG`**: fetches data from the previous row. [Learn more](https://spark.apache.org/docs/latest/api/sql/#lag). <br>\n**`LEAD`**: fetches data from a subsequent row. [Learn more](https://spark.apache.org/docs/latest/api/sql/#lead).<br>\n\nExamine the code in the next cell. \n\n`line 1`: We create or replace a temporary view names `updates`<br>\n`line 2`: We are using a CTAS pattern to create this new view<br>\n`line 3`: We select a subgroup of columns to include from the window function defined in lines 5 - 8. Note the expression `(prev_amt+next_amt)/2`. For any missing entry, we calculate a new data point that is the mean of the previous entry and the subsequent entry. These values are defined in the window function below <br>\n`line 4`: Indicates the window function as the source. The parenthesis marks the start of the window function<br>\n`line 5`: Select all columns from `health_tracker_silver`<br>\n`line 6`: `LAG` gets the `heartrate` from the previous row. We define the window by `device_id` and `dte` so that the calculation is applied to each missing value **by device** <br>\n`line 9`: Marks the end of the window function<br>\n`line 10`: Identifies that this calulation should apply **only** where the heartrate reading is less than 0\n\n<img alt=\"Side Note\" title=\"Side Note\" style=\"vertical-align: text-bottom; position: relative; height:1.75em; top:0.05em; transform:rotate(15deg)\" src=\"https://files.training.databricks.com/static/images/icon-note.webp\"/> **Interpolation** is a type of estimation where we construct new data points based on a set of known data points. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"22d80f34-c420-42a8-9d40-de690ede4265"},{"version":"CommandV1","origId":3623476344927189,"guid":"03bc1dcb-a7fd-40e7-87f2-7884bc6a5276","subtype":"command","commandType":"auto","position":6.0,"command":"CREATE OR REPLACE TEMPORARY VIEW updates \nAS (\n  SELECT name, (prev_amt+next_amt)/2 AS heartrate, time, dte, p_device_id\n  FROM (\n    SELECT *, \n    LAG(heartrate) OVER (PARTITION BY p_device_id, dte ORDER BY p_device_id, dte) AS prev_amt, \n    LEAD(heartrate) OVER (PARTITION BY p_device_id, dte ORDER BY p_device_id, dte) AS next_amt \n    FROM health_tracker_silver\n  ) \n  WHERE heartrate < 0\n)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"bfb80331-28fd-4db6-9a7b-247e908662e9"},{"version":"CommandV1","origId":3623476344927190,"guid":"c9eb900e-60eb-4ed5-8d72-ad59f833bd51","subtype":"command","commandType":"auto","position":7.0,"command":"%md\n## Check schema\n\nWe will want to use the values in `updates` to update our `health_tracker_silver` table. Let's check both schemas to see if they match. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"10c0da3d-ce04-476b-af8c-21a4b57c1614"},{"version":"CommandV1","origId":3623476344927191,"guid":"498a9f9a-34a6-40a9-8784-5435820cb0e3","subtype":"command","commandType":"auto","position":8.0,"command":"DESCRIBE updates","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1dc66c72-978c-4740-b75c-01fd88589e7c"},{"version":"CommandV1","origId":3623476344927192,"guid":"72aa713b-4050-4124-ac50-36c5b4a9d3d2","subtype":"command","commandType":"auto","position":9.0,"command":"DESCRIBE health_tracker_silver","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f2273d78-2b91-4391-9d1f-8d3c581f55a4"},{"version":"CommandV1","origId":3623476344927193,"guid":"1fb39254-cb1f-454d-bb20-68495589a19e","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n## Late-arriving data\n\nWe're ready to update our silver table with our interpolated values, but before we do, we find out that those missing readings have finally come through! We can get that data ready to merge with our other updates. \n\nRun the cell below to read in the raw data. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"504f4c26-ac33-4de9-955a-90b704dfa29f"},{"version":"CommandV1","origId":3623476344927194,"guid":"bd1ef30b-5b3f-406c-9a46-9afb5495e0f3","subtype":"command","commandType":"auto","position":11.0,"command":"DROP TABLE IF EXISTS health_tracker_data_2020_02_late;              \n\nCREATE TABLE health_tracker_data_2020_02_late                        \nUSING json                                             \nOPTIONS (\n  path \"dbfs:/mnt/training/healthcare/tracker/raw-late.json\",\n  inferSchema \"true\"\n  );","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e9984210-58ad-41fd-856b-1f58dd1999a7"},{"version":"CommandV1","origId":3623476344927195,"guid":"31c08cd6-c85a-4a4d-94f2-543f3abad0b6","subtype":"command","commandType":"auto","position":12.0,"command":"%md\n## Prepare inserts\n\nWe can apply the same transformations we used to create our `health_tracker_silver` table on this raw data. This we'll give us a view with the same schema as our other tables and views.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f5ce54a3-01ef-41b2-89e5-d21ba27b25ff"},{"version":"CommandV1","origId":3623476344927196,"guid":"d0b3603b-f8a5-42d5-8a28-97e9fed0ebea","subtype":"command","commandType":"auto","position":13.0,"command":"CREATE OR REPLACE TEMPORARY VIEW inserts AS (\n  SELECT\n    value.name,\n    value.heartrate,\n    CAST(FROM_UNIXTIME(value.time) AS timestamp) AS time,\n    CAST(FROM_UNIXTIME(value.time) AS DATE) AS dte,\n    value.device_id p_device_id\n  FROM\n    health_tracker_data_2020_02_late\n)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ff11e03b-e944-44f9-8099-c42c809bad4a"},{"version":"CommandV1","origId":3623476344927197,"guid":"8f2fd6a1-746e-49ce-b591-63633b80c757","subtype":"command","commandType":"auto","position":14.0,"command":"%md\n## Prepare upserts\n\nThe word \"upsert\" is a portmanteau of the words \"update\" and \"insert,\" and this is what it does. An upsert will update records where some criteria are met and otherwise will insert the record. We create a view that is the union of our `updates` and `inserts` and holds all records we would like to add and modify.\n\nHere, we use `UNION ALL` to capture all records in both views, even duplicates. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6a86da54-4b0b-4063-b845-e8daccbdb26c"},{"version":"CommandV1","origId":3623476344927198,"guid":"1fff53bb-c776-45ef-ab18-5a79b0213a09","subtype":"command","commandType":"auto","position":15.0,"command":"CREATE OR REPLACE TEMPORARY VIEW upserts\nAS (\n    SELECT * FROM updates \n    UNION ALL \n    SELECT * FROM inserts\n    )","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"788acd06-4724-456d-b74d-44b7b0c32fc1"},{"version":"CommandV1","origId":3623476344927199,"guid":"7bdd119d-74f3-4b6b-82e9-8630a98da053","subtype":"command","commandType":"auto","position":16.0,"command":"%md\n## Perform upsert \n\nWhen upserting into an existing Delta table, use Spark SQL to perform the merge from another registered table or view. The Transaction Log records the transaction, and the Metastore immediately reflects the changes.  \n\nThe merge appends both the new/inserted files and the files containing the updates to the Delta file directory. The transaction log tells the Delta reader which file to use for each record.\n\nThis operation is similar to the SQL `MERGE` command but has added support for deletes and other conditions in updates, inserts, and deletes. In other words, using the Spark SQL command `MERGE` provides full support for an upsert operation.\n\nUse the comments to better understand how this command integrates records from our existing tables and views. \n\nRead more about `MERGE INTO` [here](https://docs.databricks.com/spark/latest/spark-sql/language-manual/merge-into.html#merge-into--delta-lake-on-databricks).","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5abb5c82-e2ff-42cc-97c5-648f16061232"},{"version":"CommandV1","origId":3623476344927200,"guid":"76da9d0d-1279-497f-b080-1d71a9847217","subtype":"command","commandType":"auto","position":17.0,"command":"MERGE INTO health_tracker_silver                            -- the MERGE instruction is used to perform the upsert\nUSING upserts\n\nON health_tracker_silver.time = upserts.time AND        \n   health_tracker_silver.p_device_id = upserts.p_device_id  -- ON is used to describe the MERGE condition\n   \nWHEN MATCHED THEN                                           -- WHEN MATCHED describes the update behavior\n  UPDATE SET\n  health_tracker_silver.heartrate = upserts.heartrate   \nWHEN NOT MATCHED THEN                                       -- WHEN NOT MATCHED describes the insert behavior\n  INSERT (name, heartrate, time, dte, p_device_id)              \n  VALUES (name, heartrate, time, dte, p_device_id)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"95db7571-2caf-4d3f-a1b6-42a20d54f234"},{"version":"CommandV1","origId":3623476344927201,"guid":"fa481224-a566-4a48-9800-1b8217ff1869","subtype":"command","commandType":"auto","position":18.0,"command":"%md\n## Time travel\n\nLet's check the number of records in the different versions of our tables. \n\nVersion 1 shows the data after we added records from February. Recall that this is where we first discovered the missing records. \n\nThe current version shows everything including the records we upcerted.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"146f8f17-ec2e-4568-a69a-1df9047cba27"},{"version":"CommandV1","origId":3623476344927202,"guid":"edf87fc8-98c2-49ce-a90a-f4d8b319e64d","subtype":"command","commandType":"auto","position":19.0,"command":"-- VERSION 1\nSELECT COUNT(*) FROM health_tracker_silver VERSION AS OF 1","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d586d2c4-b653-470d-a5ae-f5ffc1a3e8bf"},{"version":"CommandV1","origId":3623476344927203,"guid":"e6199247-9f78-4818-96f2-967531893e0e","subtype":"command","commandType":"auto","position":20.0,"command":"-- CURRENT VERSION\nSELECT COUNT(*) FROM health_tracker_silver","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ac7eadbf-967f-4a8f-8969-ea8784f9dd46"},{"version":"CommandV1","origId":3623476344927204,"guid":"1ea34196-ef48-439b-bb52-f0fab60a0ffc","subtype":"command","commandType":"auto","position":21.0,"command":"%md\n## Describe history\n You can check the full history of a Delta table including the operation, user, and so on for each new write to a table. \n ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"14ec1730-4f20-41d7-b109-ed19d139edb7"},{"version":"CommandV1","origId":3623476344927205,"guid":"5fea3043-2b53-45c3-9666-03c9f7410cd2","subtype":"command","commandType":"auto","position":22.0,"command":"DESCRIBE HISTORY health_tracker_silver","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"67bd1072-aade-4d9b-a51a-0db72c462007"},{"version":"CommandV1","origId":3623476344927206,"guid":"09d4b082-15cf-441b-9b3a-6aab082d9c25","subtype":"command","commandType":"auto","position":23.0,"command":"%md\n## Write to gold\n\nSo far, we have ingested raw (bronze-level) data and applied transformations to create a silver table. We have used Spark SQL to explore and transform that data further, adding new values when we found collection errors and updating the table to reflect late-arriving data. Now that our data is clean and polished, we can write to a gold table. Gold tables are used to hold business level aggregates. When we create this table, we also apply aggregate functions to several columns. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2e0849e1-4c09-41e5-9794-2a12f7093e26"},{"version":"CommandV1","origId":3623476344927207,"guid":"6ad9f33a-3183-4339-b23a-ff588eba2773","subtype":"command","commandType":"auto","position":24.0,"command":"DROP TABLE IF EXISTS health_tracker_gold;              \n\nCREATE TABLE health_tracker_gold                        \nUSING DELTA\nLOCATION \"/health_tracker/gold\"\nAS \nSELECT \n  AVG(heartrate) AS meanHeartrate,\n  STD(heartrate) AS stdHeartrate,\n  MAX(heartrate) AS maxHeartrate\nFROM health_tracker_silver\nGROUP BY p_device_id\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"451c615d-0cb9-410f-84d4-80e33f365497"},{"version":"CommandV1","origId":3623476344927208,"guid":"dafa4c58-4090-4eb4-a2b5-eb3736540f59","subtype":"command","commandType":"auto","position":25.0,"command":"SELECT\n  *\nFROM\n  health_tracker_gold","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cf9a6410-7c47-4516-bac9-b482f108e1c5"},{"version":"CommandV1","origId":3623476344927209,"guid":"14f82dce-ee89-4cbc-91bb-e12c66409e4a","subtype":"command","commandType":"auto","position":26.0,"command":"%md\n## Cleanup\nRun the next cell to clean up your classroom environment","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c365a1bb-cd8b-42b6-889b-665162576ddf"},{"version":"CommandV1","origId":3623476344927210,"guid":"6b0ede86-cbeb-48e8-9349-478dc511f62b","subtype":"command","commandType":"auto","position":27.0,"command":"%run ../Includes/Classroom-Cleanup","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7d6f2377-bf2b-420f-b41c-00abd55eea8c"},{"version":"CommandV1","origId":3623476344927211,"guid":"f2427113-a043-441b-8783-898ccc6b67d9","subtype":"command","commandType":"auto","position":28.0,"command":"%md\nGreat work! Now that you've got a basic understanding of how data moves through the Delta architecture, we're ready to get back to analytics. In the next reading, we'll see how to write high-performance Spark queries with Databricks Delta. \n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"955e3ebd-e3af-4c81-af62-757ed7d65c52"},{"version":"CommandV1","origId":3623476344927212,"guid":"1cc63c23-94ee-4eb7-877a-46a6d36d01b8","subtype":"command","commandType":"auto","position":29.0,"command":"%md-sandbox\n&copy; 2020 Databricks, Inc. All rights reserved.<br/>\nApache, Apache Spark, Spark and the Spark logo are trademarks of the <a href=\"http://www.apache.org/\">Apache Software Foundation</a>.<br/>\n<br/>\n<a href=\"https://databricks.com/privacy-policy\">Privacy Policy</a> | <a href=\"https://databricks.com/terms-of-use\">Terms of Use</a> | <a href=\"http://help.databricks.com/\">Support</a>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"57a1d9ee-68f2-481a-939c-996f8cbb9bac"}],"dashboards":[],"guid":"cdcd07c3-5c1b-4199-b05e-84848645d0ff","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{}}