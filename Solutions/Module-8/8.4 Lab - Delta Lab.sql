{"version":"NotebookV1","origId":3623476344927351,"name":"8.4 Lab - Delta Lab","language":"sql","commands":[{"version":"CommandV1","origId":3623476344927352,"guid":"3d9030db-6866-463e-9242-3d51a420a007","subtype":"command","commandType":"auto","position":1.0,"command":"\n%md-sandbox\n\n<div style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://databricks.com/wp-content/uploads/2018/03/db-academy-rgb-1200px.png\" alt=\"Databricks Learning\" style=\"width: 600px\">\n</div>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f65be0d1-7f43-4f6c-9bef-5f7c55d5dadb"},{"version":"CommandV1","origId":3623476344927353,"guid":"f36297d0-8a86-4036-98d2-a8e971bb9cc8","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n# Lab 4 - Delta Lab\n## Module 8 Assignment\nIn this lab, you will continue your work on behalf of Moovio, the fitness tracker company. You will be working with a new set of files that you must move into a \"gold-level\" table. You will need to modify and repair records, create new columns, and merge late-arriving data. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f05665f3-6056-46f4-9ec1-69ee5692e074"},{"version":"CommandV1","origId":3623476344927354,"guid":"36f91e6a-9b29-4a95-979b-951bdc447bbf","subtype":"command","commandType":"auto","position":3.0,"command":"%run ../Includes/Classroom-Setup","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c46e16bd-c64a-4c3d-9239-880d5c0ed1f9"},{"version":"CommandV1","origId":3623476344927355,"guid":"9b49e39a-7617-4770-91d4-56c3942d3cb0","subtype":"command","commandType":"auto","position":4.0,"command":"%md\n## Exercise 1: Create a table\n\n**Summary:** Create a table from `json` files. \n\nUse this path to access the data: <br>\n`\"dbfs:/mnt/training/healthcare/tracker/raw.json/\"`\n\nSteps to complete: \n* Create a table named `health_tracker_data_2020`\n* Use optional fields to indicate the path you're reading from and epress that the schema should be inferred. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"811ab21c-72b0-41a8-94c6-bdc7687bb1ca"},{"version":"CommandV1","origId":3623476344927356,"guid":"80abed72-cd14-4b3d-9a20-48efef1b9866","subtype":"command","commandType":"auto","position":5.0,"command":"-- ANSWER\nDROP TABLE IF EXISTS health_tracker_data_2020;              \n\nCREATE TABLE health_tracker_data_2020                        \nUSING json                                             \nOPTIONS (\n  path \"dbfs:/mnt/training/healthcare/tracker/raw.json\",\n  inferSchema \"true\"\n  );\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"00f24814-746d-4c50-a3d5-561bda53c4ae"},{"version":"CommandV1","origId":3623476344927357,"guid":"a16fdd75-74dc-4885-b94a-1d8053b496fa","subtype":"command","commandType":"auto","position":6.0,"command":"%md\n## Exercise 2: Preview the data\n\n**Summary:**  View a sample of the data in the table. \n\nSteps to complete: \n* Query the table with `SELECT *` to see all columns\n* Sample 5 rows from the table","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0e5a1519-9e84-40bd-bff4-dd89539117a2"},{"version":"CommandV1","origId":3623476344927358,"guid":"8e280f6a-4b59-4527-a338-e60b8ca6f099","subtype":"command","commandType":"auto","position":7.0,"command":"-- ANSWER\nSELECT * FROM health_tracker_data_2020 TABLESAMPLE (5 ROWS)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0643a4ad-fa1b-41ab-a1fe-12ac694a7848"},{"version":"CommandV1","origId":3623476344927359,"guid":"2293184b-5261-4b70-8782-3a69c324064d","subtype":"command","commandType":"auto","position":8.0,"command":"%md\n## Exercise 3: Count Records\n**Summary:** Write a query to find the total number of records\n\nSteps to complete: \n* Count the number of records in the table\n\n**Answer the corresponding question in Coursera**","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"def43348-4a80-4d7d-ab3f-35db26ec678c"},{"version":"CommandV1","origId":3623476344927360,"guid":"74374e98-957a-46f2-987d-ad50daefbe41","subtype":"command","commandType":"auto","position":9.0,"command":"-- ANSWER\nSELECT COUNT(*) FROM health_tracker_data_2020","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"db5a77f7-397a-4b4d-aa26-38027ca84ea8"},{"version":"CommandV1","origId":3623476344927361,"guid":"3f5941a6-c065-4e04-8be4-83095b31845f","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n## Exercise 4: Create a Silver Delta table\n**Summary:** Create a Delta table that transforms and restructures your table\n\nSteps to complete: \n* Drop the existing `month` column\n* Isolate each property of the object in the `value` column to its own column\n* Cast time as timestamp **and** as a date\n* Partition by `device_id`\n* Use Delta to write the table","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7655f21c-6c96-4641-bdcb-21ac677297a9"},{"version":"CommandV1","origId":3623476344927362,"guid":"21f2a1e5-385d-475f-97c7-3b990da7f3e7","subtype":"command","commandType":"auto","position":11.0,"command":"-- ANSWER\nCREATE OR REPLACE TABLE health_tracker_silver \nUSING DELTA\nPARTITIONED BY (p_device_id)\nLOCATION \"dbfs:/health_tracker/silver\" AS (\nSELECT\n  value.name,\n  value.heartrate,\n  CAST(FROM_UNIXTIME(value.time) AS timestamp) AS time,\n  CAST(FROM_UNIXTIME(value.time) AS DATE) AS dte,\n  value.device_id p_device_id\nFROM\n  health_tracker_data_2020\n)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b16fb2bb-54f3-4a61-9aaa-c68ce51b37e1"},{"version":"CommandV1","origId":3623476344927363,"guid":"4d891aa2-4986-4b78-8af7-e9bb4bf7c8d8","subtype":"command","commandType":"auto","position":12.0,"command":"%md\n## Exercise 5: Register table to the metastore\n**Summary:** Register your Silver table to the Metastore\nSteps to complete: \n* Be sure you can run the cell more than once without throwing an error\n* Write to the location: `/health_tracker/silver`","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"446badec-f2db-4db0-93b8-172c4da9205f"},{"version":"CommandV1","origId":3623476344927364,"guid":"91633cc6-e574-4959-b1a7-d9790991f229","subtype":"command","commandType":"auto","position":13.0,"command":"-- ANSWER\nDROP TABLE IF EXISTS health_tracker_silver;\nCREATE TABLE health_tracker_silver\nUSING DELTA\nLOCATION \"/health_tracker/silver\"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7ba860a7-4ea0-483f-bbff-da04821f8db9"},{"version":"CommandV1","origId":3623476344927365,"guid":"5711ec1c-1b23-4a8a-a179-9aac6a2c26f6","subtype":"command","commandType":"auto","position":14.0,"command":"%md\n## Exercise 6: Check the number of records\n**Summary:** Check to see if all devices are reporting the same number of records\n\nSteps to complete: \n* Write a query that counts the number of records for each device\n* Include your partitioned device id column and the count of those records\n\n**Answer the corresponding question in Coursera**","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"09e71f18-b5c0-4877-a64d-4c8b0a584d4a"},{"version":"CommandV1","origId":3623476344927366,"guid":"766c1eb0-243a-468b-945c-9f3e026148e3","subtype":"command","commandType":"auto","position":15.0,"command":"--ANSWER\n\nSELECT p_device_id, COUNT(*) FROM health_tracker_silver GROUP BY p_device_id","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e67d9d87-3069-46bb-8312-8fa5a7c4823c"},{"version":"CommandV1","origId":3623476344927367,"guid":"022b35a0-cb92-4280-bed2-f6b566637572","subtype":"command","commandType":"auto","position":16.0,"command":"%md\n## Exercise 7: Plot records\n**Summary:** Attempt to visually assess which dates may be missing records\n\nSteps to complete: \n* Write a query that will return records from one devices that is **not** missing records as well as the device that seems to be missing records\n* Plot the results to visually inspect the data\n* Identify dates that are missing records\n\n**Answer the corresponding question in Coursera**","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6df150b7-a838-4b30-9faf-3199570fed3d"},{"version":"CommandV1","origId":3623476344927368,"guid":"6b409f60-0e51-4df6-98be-3047d013400b","subtype":"command","commandType":"auto","position":17.0,"command":"--ANSWER\nSELECT * FROM health_tracker_silver WHERE p_device_id IN (3,4)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"aefa05b9-033a-434a-a8c9-fbc441200a3e"},{"version":"CommandV1","origId":3623476344927369,"guid":"2ee8cc26-0696-497b-80a2-336f19262c3e","subtype":"command","commandType":"auto","position":18.0,"command":"%md\n## Exercise 8: Check for Broken Readings\n**Summary:** Check to see if your data contains records that would indicate a device has misreported data\nSteps to complete: \n* Create a view that contains all records reporting a negative heartrate\n* Plot/view that data to see which days include broken readings","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6a95ca44-bd4d-41bc-bc80-adfe48f03319"},{"version":"CommandV1","origId":3623476344927370,"guid":"ea257bf5-6753-420a-9ae3-aed90e4bd2e6","subtype":"command","commandType":"auto","position":19.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW broken_readings\nAS (\n  SELECT COUNT(*) as broken_readings_count, dte FROM health_tracker_silver\n  WHERE heartrate < 0\n  GROUP BY dte\n  ORDER BY dte\n);\n\nSELECT * FROM broken_readings;\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"274dbec6-9785-4989-a2b3-7929564c685e"},{"version":"CommandV1","origId":3623476344927371,"guid":"c57bd035-523d-49e1-8146-df9f9aa5358f","subtype":"command","commandType":"auto","position":20.0,"command":"%md\n## Exercise 9: Repair records\n**Summary:** Create a view that contains interpolated values for broken readings\n\nSteps to complete: \n* Create a temporary view that will hold all the records you want to update. \n* Transform the data such that all broken readings (where heartrate is reported as less than zero) are interpolated as the mean of the the data points immediately surrounding the broken reading. \n* After you write the view, count the number of records in it. \n\n**Answer the corresponding question in Coursera** ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cfd2b6f8-2b75-4fb5-a8ff-dd2ff5da1e2c"},{"version":"CommandV1","origId":3623476344927372,"guid":"89045045-256d-4ff7-b51c-571de7021bb9","subtype":"command","commandType":"auto","position":21.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW updates \nAS (\n  SELECT name, (prev_amt+next_amt)/2 AS heartrate, time, dte, p_device_id\n  FROM (\n    SELECT *, \n    LAG(heartrate) OVER (PARTITION BY p_device_id, dte ORDER BY p_device_id, dte) AS prev_amt, \n    LEAD(heartrate) OVER (PARTITION BY p_device_id, dte ORDER BY p_device_id, dte) AS next_amt \n    FROM health_tracker_silver\n  ) \n  WHERE heartrate < 0\n);\n\nSELECT COUNT(*) FROM updates;","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"68414e00-549c-41a2-968f-1e50986a749d"},{"version":"CommandV1","origId":3623476344927373,"guid":"fc11285c-d594-42ea-9084-f81489d3aa3b","subtype":"command","commandType":"auto","position":22.0,"command":"%md\n## Exercise 10: Read late-arriving data\n**Summary:** Read in new late-arriving data\n\nSteps to complete: \n* Create a new table that contains the late arriving data at this path: `\"dbfs:/mnt/training/healthcare/tracker/raw-late.json\"`\n* Count the records <br/>\n\n**Answer the corresponding question in Coursera**","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"58628754-b8ed-4b7d-a8e3-6e21c37886c5"},{"version":"CommandV1","origId":3623476344927374,"guid":"90161ca6-5c73-4385-a059-b0365bdea449","subtype":"command","commandType":"auto","position":23.0,"command":"--ANSWER\nDROP TABLE IF EXISTS late_arriving_data;              \n\nCREATE TABLE late_arriving_data                        \nUSING json                                             \nOPTIONS (\n  path \"dbfs:/mnt/training/healthcare/tracker/raw-late.json\",\n  inferSchema \"true\"\n  );\n  \n\nSELECT COUNT(*) FROM late_arriving_data","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f77d7215-7e06-42fb-9ab4-a408a9f56d2d"},{"version":"CommandV1","origId":3623476344927375,"guid":"99ebddec-49e9-40d2-9251-3ed319c5c3e9","subtype":"command","commandType":"auto","position":24.0,"command":"%md\n## Exercise 11: Prepare inserts\n**Summary:** Prepare your new, late-arriving data for insertion into the Silver table\n\nSteps to complete: \n* Create a temporary view that holds the new late-arriving data\n* Apply transformations to the data so that the schema matches our existing Silver table","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"09740c4c-9e93-4d06-ab96-225193e930f5"},{"version":"CommandV1","origId":3623476344927376,"guid":"eb660493-e056-410a-af16-0180b00f4c3a","subtype":"command","commandType":"auto","position":25.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW inserts AS (\n  SELECT\n    value.name,\n    value.heartrate,\n    CAST(FROM_UNIXTIME(value.time) AS timestamp) AS time,\n    CAST(FROM_UNIXTIME(value.time) AS DATE) AS dte,\n    value.device_id p_device_id\n  FROM\n    late_arriving_data\n);\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d151c64f-f27f-4b0a-bc11-1f5637c70b0b"},{"version":"CommandV1","origId":3623476344927377,"guid":"06d247fa-f08f-42a7-a88c-ddb4051deaba","subtype":"command","commandType":"auto","position":26.0,"command":"%md\n## Exercise 12: Prepare upserts\n**Summary:** Prepare a view to upsert to our Silver table\n\nSteps to complete: \n* Create a temporary view that is the `UNION` of the views that hold data you want to insert and data you want to update\n* Count the records\n\n**Answer the corresponding question in Coursera**","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"05b5c12f-2e8d-4994-9a9c-a97949ce5476"},{"version":"CommandV1","origId":3623476344927378,"guid":"9250625b-aa4c-41bb-9388-b523c18001f0","subtype":"command","commandType":"auto","position":27.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW upserts\nAS (\n    SELECT * FROM updates \n    UNION ALL \n    SELECT * FROM inserts\n    );\n\nSELECT COUNT(*) FROM upserts;","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"072630af-c32b-4161-bcf6-fa21b57c5e06"},{"version":"CommandV1","origId":3623476344927379,"guid":"3614c739-dc1e-43e0-bb99-1591031a7714","subtype":"command","commandType":"auto","position":28.0,"command":"%md\n## Exercise 13: Perform upserts\n\n**Summary:** Merge the upserts into your Silver table\n\nSteps to complete: \n* Merge data on the time and device id columns from your Silver table and your upserts table\n* Use `MATCH`conditions to decide whether to apply an update or an insert","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"fedba2cd-bc55-4bbb-837e-d33a09f30ae6"},{"version":"CommandV1","origId":3623476344927380,"guid":"506958fd-8454-4888-8211-1c043a6087b4","subtype":"command","commandType":"auto","position":29.0,"command":"--ANSWER\n\nMERGE INTO health_tracker_silver                             \nUSING upserts\n\nON health_tracker_silver.time = upserts.time AND        \n   health_tracker_silver.p_device_id = upserts.p_device_id   \n   \nWHEN MATCHED THEN                                            \n  UPDATE SET\n  health_tracker_silver.heartrate = upserts.heartrate   \nWHEN NOT MATCHED THEN                                        \n  INSERT (name, heartrate, time, dte, p_device_id)              \n  VALUES (name, heartrate, time, dte, p_device_id);","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"33ed16a7-7c8a-49a3-a757-1fb5b9164982"},{"version":"CommandV1","origId":3623476344927381,"guid":"2d95ca3e-6096-4a54-9cf1-05e0e4d4f5cc","subtype":"command","commandType":"auto","position":30.0,"command":"%md\n## Exercise 14: Write to gold\n**Summary:** Create a Gold level table that holds aggregated data\n\nSteps to complete: \n* Create a Gold-level Delta table\n* Aggregate heartrate to display the average and standard deviation for each device. \n* Count the number of records","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"bc99397e-1a7b-476e-81c9-d6f8b227bd3b"},{"version":"CommandV1","origId":3623476344927382,"guid":"85833e20-7ef7-4d9f-a049-b2ac965bada7","subtype":"command","commandType":"auto","position":31.0,"command":"--ANSWER\nDROP TABLE IF EXISTS health_tracker_gold;              \n\nCREATE TABLE health_tracker_gold                        \nUSING DELTA\nLOCATION \"/health_tracker/gold\"\nAS \nSELECT \n  AVG(heartrate) AS meanHeartrate,\n  STD(heartrate) AS stdHeartrate,\n  MAX(heartrate) AS maxHeartrate\nFROM health_tracker_silver\nGROUP BY p_device_id;\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b4234c31-ea83-464d-8042-77b359ddced0"},{"version":"CommandV1","origId":3623476344927383,"guid":"f7f9ad86-545a-4773-8624-487e83a232e8","subtype":"command","commandType":"auto","position":32.0,"command":"%md\n## Cleanup\nRun the following cell to clean up your workspace. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1a6b88b6-c8e3-4e52-9e29-e2f5ffda9bf9"},{"version":"CommandV1","origId":3623476344927384,"guid":"8302f34c-88ef-4242-b0cb-b8a8c0fa214f","subtype":"command","commandType":"auto","position":33.0,"command":"-- %run .Includes/Classroom-Cleanup\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d1e96cf6-96a8-4b57-acd6-1b73d407547a"},{"version":"CommandV1","origId":3623476344927385,"guid":"4ec23546-2db5-4ff8-9c7e-8233cfd369e5","subtype":"command","commandType":"auto","position":34.0,"command":"%md-sandbox\n&copy; 2020 Databricks, Inc. All rights reserved.<br/>\nApache, Apache Spark, Spark and the Spark logo are trademarks of the <a href=\"http://www.apache.org/\">Apache Software Foundation</a>.<br/>\n<br/>\n<a href=\"https://databricks.com/privacy-policy\">Privacy Policy</a> | <a href=\"https://databricks.com/terms-of-use\">Terms of Use</a> | <a href=\"http://help.databricks.com/\">Support</a>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"977f257b-dff4-428e-9538-c1e35e9e797a"}],"dashboards":[],"guid":"645efd4b-b2b1-4065-a1cc-b138065cf27a","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{}}