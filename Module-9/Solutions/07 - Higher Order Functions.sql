{"version":"NotebookV1","origId":3623476344927644,"name":"07 - Higher Order Functions","language":"sql","commands":[{"version":"CommandV1","origId":3623476344927645,"guid":"6dde5c40-493e-4277-9f53-98bc4f85d6ae","subtype":"command","commandType":"auto","position":1.0,"command":"\n%md-sandbox\n\n<div style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://databricks.com/wp-content/uploads/2018/03/db-academy-rgb-1200px.png\" alt=\"Databricks Learning\" style=\"width: 600px\">\n</div>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"bfb724ce-7e3a-4cdd-a16f-a639cee44f76"},{"version":"CommandV1","origId":3623476344927646,"guid":"e8af0c09-ae23-4102-8ef0-e2c416985d14","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n## Create Tables\nRun the cell below to create tables for the questions in this notebook. ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a9c35cc9-b8e7-4237-9918-755352feea70"},{"version":"CommandV1","origId":3623476344927647,"guid":"afa65ccd-7fd5-4b03-a04b-1798505b9a5c","subtype":"command","commandType":"auto","position":3.0,"command":"%run ../Utilities/07-CreateTables","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"32b8068e-22b2-47da-b696-6b78fe4f8300"},{"version":"CommandV1","origId":3623476344927648,"guid":"b5352953-796d-4592-b0d0-40e81b644e89","subtype":"command","commandType":"auto","position":4.0,"command":"%md\n## Question 1: Transform\n### Summary\nUse the **`TRANSFORM`** function and the table **`finances`** to calculate **`interest`** for all cards issued to each user. \n\n\n### Steps to complete\nWrite a SQL query that achieves the following: \n* Displays cardholder's **`firstName`**, **`lastName`**, and a new column named **`interest`**\n* Uses **`TRANSFORM`** to extract charges for each card in the expenses column and calculates interest owed assuming a rate of 6.25%. \n* Stores the new values as an array in the interest column\n* Stores results in a temporary table named `q1Results`\n\nA properly completed solution should return a view that looks similar to this:\n\n| firstName | lastName | interest |\n|----------- |---------|----------|\n|Lance|Da Costa|[138.9, 373.55, 158.97]|","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"464fed28-722c-4c4d-94dd-53c55ef45d33"},{"version":"CommandV1","origId":3623476344927649,"guid":"1e9bd253-bef7-40d2-b715-0fdd58b9b565","subtype":"command","commandType":"auto","position":5.0,"command":"--ANSWER\nSELECT firstName, lastName, \nTRANSFORM(expenses, card -> ROUND(card.charges * 0.0625, 2)) AS interest \nFROM finances\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"18dff282-4d5d-4668-96a1-42ccaaca96e6"},{"version":"CommandV1","origId":3623476344927650,"guid":"fc98c504-d15b-40e6-89ee-c77eb9719710","subtype":"command","commandType":"auto","position":6.0,"command":"%md\n## Question 2: Exists\n### Summary\nUse the table from Question 1, **`finances`**, to flag users whose records indicate that they made a late payment. \n\n### Steps to complete\nWrite a SQL query that achieves the following: \n* Displays cardholder's **`firstName`**, **`lastName`**, and a new column named **`lateFee`**\n* Uses the EXISTS function to flag customers who have made been charged a late payment fee.\n* Store the results in a temporary view named **`q2Results`**\n   \nA properly completed solution should return a DataFrame that looks similar to this:\n\n| firstName | lastName | lateFee |\n|---------- |----------| ------- |\n|Lance|DaCosta |true|","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"08f8919c-24db-4fd4-b5ff-522071cc6f05"},{"version":"CommandV1","origId":3623476344927651,"guid":"e917bc83-8713-42c2-b001-9952d6cbafdb","subtype":"command","commandType":"auto","position":7.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW q2Results AS\n  SELECT firstName, lastName,\n  EXISTS(expenses, card -> TO_DATE(card.paymentDue) > TO_DATE(card.lastPayment)) AS lateFee\n  FROM finances;\n\nSELECT * FROM q2Results","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"75fc88e6-e017-42d3-9370-bac6d44e595a"},{"version":"CommandV1","origId":3623476344927652,"guid":"cf1ba9d6-b96e-4ce1-b1cd-1a35c8c7e1fa","subtype":"command","commandType":"auto","position":8.0,"command":"%md\n## Question 3: Reduce\n### Summary\nUse the **`REDUCE`** function to produce a query on the table **`charges`** that calculates total charges in dollars and total charges in Japanese Yen. \n\n### Steps to complete\nWrite a SQL query that achieves the following: \n* Uses the **`REDUCE`** function to calculate the total charges in US Dollars (given)\n* Uses the **`REDUCE`** function to convert the total charges to Japanese Yen using a conversion rate where 1 USD = 107.26 JPY \n* Stores the results in a temporary table named **`q3Results`**\n   \n**NOTE:** In the `REDUCE` function, the accumulator must be of the same type as the input. You will have to `CAST` the accumulator as a `DOUBLE` to use this function with this data. \nexample: `CAST (0 AS DOUBLE`)\n\nA properly completed solution should return a DataFrame that looks similar to this:\n\n| firstName | lastName | allCharges | totalDollars | totalYen |\n|---------- |----------| ------- | --------| ----------|\n|Lance|DaCosta |[\"2222.46\", \"5976.76\", \"2543.55\"]|10742.77|1152269.51|","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7dc93829-b13e-469e-a3fc-09e5c451eb7c"},{"version":"CommandV1","origId":3623476344927653,"guid":"4acfd658-2652-4aeb-ac69-85dcfad7516a","subtype":"command","commandType":"auto","position":9.0,"command":"--ANSWER\nCREATE OR REPLACE TEMPORARY VIEW q3Results AS\n  SELECT firstName, lastName, allCharges, \n  REDUCE (allCharges, CAST(0 AS DOUBLE), (charge, acc) -> charge + acc) AS totalDollars,\n  REDUCE (allCharges, CAST(0 AS DOUBLE), (charge, acc) -> charge + acc, acc -> ROUND(acc * 107.26, 2)) AS totalYen\n  FROM charges;\n\nSELECT * FROM q3Results\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"697eb3d9-31b9-4ee9-ba73-d69a31c1ce0d"},{"version":"CommandV1","origId":3623476344927654,"guid":"036b4912-419e-45c1-a9c4-bc81ab1fc715","subtype":"command","commandType":"auto","position":10.0,"command":"%md-sandbox\n&copy; 2020 Databricks, Inc. All rights reserved.<br/>\nApache, Apache Spark, Spark and the Spark logo are trademarks of the <a href=\"http://www.apache.org/\">Apache Software Foundation</a>.<br/>\n<br/>\n<a href=\"https://databricks.com/privacy-policy\">Privacy Policy</a> | <a href=\"https://databricks.com/terms-of-use\">Terms of Use</a> | <a href=\"http://help.databricks.com/\">Support</a>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"9b798560-caa0-4818-b5eb-75b3237ff1e5"}],"dashboards":[],"guid":"17174567-d384-4059-b553-7cd01fb88774","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":2}}